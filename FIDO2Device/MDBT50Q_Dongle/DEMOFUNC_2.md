# デモ機能（BLEデバイスによる自動認証）

## 概要

FIDO認証（WebAuthn／U2F）実行時、MDBT50Q Dongle上のボタンを押す代わりに、One CardなどのBLEデバイスを近づけることにより、認証処理を自動的に続行させる機能です。

### 事前設定

このデモ機能を実行させる前に、事前にMDBT50Q Dongleに対し、以下の設定を行う必要があります。

- <b>スキャン対象サービスUUID</b><br>
自動認証させたいBLEデバイスが持つサービスUUID（スキャン対象サービスUUID）を設定します。<br>
スキャン対象サービスUUIDが、MDBT50Q Dongleに未設定の場合、自動認証機能は実行されません。

- <b>スキャン秒数</b><br>
スキャン対象サービスUUIDをもつBLEデバイスをスキャンする秒数を設定します。<br>
特にスキャン秒数を設定しなかった場合、デフォルト＝３秒となります。

### 制約事項

- <b>ビーコン等は使用不可</b><br>
何らかのサービスUUIDを持つ、BLEペリフェラルデバイスのみが、この機能を利用できます。<br>
BLEビーコンなど、サービスUUIDを持たないBLEデバイスは利用できません。

- <b>ユーザー所在確認ボタンは使用不可</b><br>
このBLEデバイスによる自動認証機能が実行中は、成り代わり防止の観点から、ボタン押下を検知しない実装としています。<br>
したがって、MDBT50Q Dongle上のボタン（ユーザー所在確認ボタン）は利用できません。

## 動作方法

以下、Windows10 PC環境での手順を記載いたします。

### 仮想COMポートに接続

ターミナルアプリ「Tera Term」を使用し、仮想COMポートに接続します。<br>
手順につきましては、手順書「[仮想COMポートへの接続手順](../../FIDO2Device/MDBT50Q_Dongle/CDCCONNECT.md)」をご参照願います。

### スキャン対象サービスUUIDの設定

自動認証させたいBLEデバイスが持つサービスUUID（スキャン対象サービスUUID）を、事前にMDBT50Q Dongleに設定します。<br>
Tera Term画面上で、以下のコマンドを入力します。<br>
（下記は、スキャン対象サービスUUIDを、One Cardの「422E0000-E141-11E5-A837-0800200C9A66」とした場合の例です）
```
set_auth_uuid 422E0000-E141-11E5-A837-0800200C9A66
```
Tera Term画面上に「OK」というメッセージが戻ることを確認します。

スキャン対象サービスUUIDが設定され、自動認証機能が稼働を開始します。<br>
MDBT50Q DongleがPCから取り外された（＝電源がOffになった）後も、設定内容は保持されます。

これで、スキャン対象サービスUUIDの設定は完了です。

#### macOS環境上でのご注意

macOS上でターミナルアプリを使用して、スキャン対象サービスUUIDを設定する場合は、<b>設定完了後、MDBT50Q Dongleを一旦PCから抜いて、再度PCのUSBポートに装着してください。</b>[注]

[注] この操作を行うと、強制的に仮想COMポートから切断され、認証実行に必要なUSB HIDサービスが有効化されます。

### 認証の実行

あらかじめ、One CardなどのBLEデバイスに電源を入れ（もしくはスリープ中であればボタンを押下してスリープ解除し）ておきます。

その後、以下の手順で、FIDO認証（WebAuthn／U2F）を実行します。
- 「[Edgeブラウザーを使用したWebAuthnテスト手順](WEBAUTHNTEST.md)」
- 「[Googleアカウントのログイン確認手順（PC）](PCCHROME.md)」

手順書では、ボタンを押すよう指示していますが、自動認証機能が稼働している場合は<b>「ボタンを押す」という操作が省略できます。</b>

## 設定変更方法

### スキャン秒数の変更

BLEデバイスをスキャンする秒数は、デフォルト＝３秒となっております。<br>
この値を変更したい場合は、コマンド「`set_auth_uuid_scan_sec <スキャン秒数>`」を仮想COMポート経由で実行します。<br>
（下記は、スキャン秒数を５秒とした場合の例です）
```
set_auth_uuid_scan_sec 5
```

### スキャン対象サービスUUIDの取消し

スキャン対象サービスUUIDを未設定状態に戻すには、コマンド「`reset_auth_uuid`」を仮想COMポート経由で実行します。
```
reset_auth_uuid
```

これで、MDBT50Q Dongleの自動認証機能は実行されないようになります。

## 設定確認方法

### スキャン対象サービスUUIDの確認

現在設定中のスキャン対象サービスUUIDを確認するには、コマンド「`auth_uuid`」を仮想COMポート経由で実行します。
```
auth_uuid
```

スキャン対象サービスUUIDが設定されている場合は、下記のようなレスポンスが戻ります。
```
auth_uuid
Service UUID for scan: 422E0000-E141-11E5-A837-0800200C9A66
```

スキャン対象サービスUUIDが設定されていない場合は、下記のようなレスポンスが戻ります。
```
auth_uuid
Service UUID for scan: not specified
```


### スキャン秒数の確認

現在設定中のスキャン秒数を確認するには、コマンド「`auth_uuid_scan_sec`」を仮想COMポート経由で実行します。<br>
```
auth_uuid_scan_sec
```

コマンドを実行すると、下記のようなレスポンスが戻ります。
```
auth_uuid_scan_sec
Service UUID scanning time: 5 sec
```
