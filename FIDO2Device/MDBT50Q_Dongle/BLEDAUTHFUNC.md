# BLEデバイスによる自動認証機能について

## 概要
FIDO認証（WebAuthn／U2F）実行時、MDBT50Q Dongle上のボタンを押す代わりに、One CardなどのBLEデバイスを近づけることにより、認証処理を自動的に続行させる機能です。

## 前提

MDBT50Q Dongleが、PCのUSBポートに装着されていることが前提となります。<br>
すなわち、PC側に対してはUSB HIDデバイスとして機能し、本機能のために使用するBLEデバイスに対してはBLEセントラルデバイスとして機能することになります。

## 操作方法
「<b>[BLEデバイスによる自動認証機能](BLEDAUTH.md)</b>」をご参照願います。

## プログラムの実装

[WIP] プログラム実装に関する情報を掲載いたします。

## プログラムの仕様

プログラムの仕様に関する情報を掲載いたします。

#### 自動認証関連コマンド

[管理ツール](../../MaintenanceTool/README.md)の「ツール設定」画面から、MDBT50Q Dongleに対して実行されるコマンドです。

- 設定読込<br>
MDBT50Q Dongleで保持されている自動認証パラメーター（自動認証に関するパラメーター）を、CSVで読込みます。

- 設定書込<br>
管理ツール画面で設定／変更された自動認証パラメーターを、CSVでMDBT50Q Dongleに転送します。<br>
転送内容はMDBT50Q Dongle側で保持されます。

- 設定解除<br>
MDBT50Q Dongleで保持されている自動認証パラメーターをクリアします。

| # |項目 |リクエスト | レスポンス |
|:-:|:-|:-|:-|
|1|設定読込|`<チャネルID> c4 00 01 01`|`<チャネルID> c4 <データ長> <ステータス> <設定内容CSV>`|
|2|設定書込|`<チャネルID> c4 <データ長>`<br>`02 <設定内容CSV>`|`<チャネルID> c4 <データ長> <ステータス> <設定内容CSV>`|
|3|設定解除|`<チャネルID> c4 00 01 03`|`<チャネルID> c4 00 05 <ステータス> 30 2c 2c 33`|

[注1] チャネルID（4バイト）は`01 00 33 01`等のバイト配列になります。事前にCTAP2_INITコマンドを実行する必要があります。<br>
[注2] データ長（2バイト）は、設定内容CSVのサイズ＋1バイト（ステータス）になります。設定内容CSVのサイズが４バイトの場合、データ長は`00 05`となります。<br>
[注3] ステータス（1バイト）は、`00`は正常終了、それ以外の値は異常終了を意味します。<br>
[注4] 設定内容CSV（可変長）は、自動認証に関するパラメーターの内容をCSV化した値になります。レイアウトは`<自動認証有効化フラグ>,<スキャン対象サービスUUID文字列>,<スキャン秒数>`となります。例えば`1,422E0000-E141-11E5-A837-0800200C9A66,3`といった値になります。

#### 自動認証設定ファイル

前述「自動認証関連コマンド」の実行により、管理ツールからMDBT50Q Dongleに引き渡された、自動認証パラメーターを保持します。<br>
nRF52840内のFlash ROMにより永続化されます。

|# |位置 |項目名 |説明 |
|:-|:-:|:-|:-|
|1|0 - 8|スキャン対象サービス<br>UUID文字列|指定したUUIDのサービスを持つBLEデバイスが、スキャン対象となります。|
|2|9 |スキャン秒数|指定した秒数の間、BLEデバイスをスキャンします。|
|3|10 |自動認証フラグ|ユーザー登録時に、BLEデバイスによる自動認証を有効化するかどうかの<br>フラグです。<br>1:有効化　0:無効化|

[注] 位置はワード単位になります（1ワード＝4バイト）。

#### BLEスキャンパラメーター

MDBT50Q Dongleは、ユーザー登録時に、下表のような「BLEスキャンパラメーター」を生成し、FIDO機能で使用する「U2Fキーハンドル」または「CTAP2クレデンシャルID」に含めて管理します。

|# |位置 |項目名 |説明 |
|:-|:-:|:-:|:-|
|1|0 |パラメーター長|ユーザー登録時にBLEデバイススキャンが行われた場合は、<br>項番2、3の長さ（22）が設定されます。<br>ボタン押下により登録された場合は、0が設定されます。|
|2|1 - 16 |サービスUUID|ユーザー登録時にスキャンされたBLEデバイスのUUID。<br>ボタン押下により登録された場合は、格納されません。|
|3|17 - 22 |Bluetoothアドレス|ユーザー登録時にスキャンされたBLEデバイスのアドレス。<br>ボタン押下により登録された場合は、格納されません。|

ログイン処理では、MDBT50Q Dongleは上記BLEスキャンパラメーターを参照し、ユーザー登録時に自動認証が使用されたか否かの判別をします。<br>
結果、ログイン時の動きとしては、以下のようになります。

|# |条件|動作 |
|:-|:-|:-|
|1|BLEスキャンパラメーター長=0|BLEデバイススキャンを行わず、ボタン押下待ちを行います。<br>ボタン押下を検知したら、ユーザー所在確認は成功となり、ログインができるようになります。<br>自動認証フラグの現在設定値は無視されます。|
|2|BLEスキャンパラメーター長>0|BLEデバイススキャンを行います。<br>自動認証パラメーターで指定したスキャン秒数の間スキャンします。<br>スキャンパラメーターのUUID／アドレスと同じデバイスがスキャンされたら、ユーザー所在確認は成功となり、ログインができるようになります。<br>結果として、ユーザー登録時と同じBLEデバイスだけが、ログイン可能となります。|
