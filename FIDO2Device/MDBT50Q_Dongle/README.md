# USBブートローダー

## dfu/open_bootloader

nRF Connectツールにより、nRF52840にアプリケーションを書込むためのブートローダー・プログラムです。<br>
Nordicのサンプルアプリ[`Open Bootloader with DFU`](https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.sdk5.v15.2.0/ble_sdk_app_open_bootloader.html)をノンカスタマイズで使用しています。

### 動作確認環境

- macOS Sierra（10.12.6）
- NetBeans IDE（8.2）
- Java SE Runtime Environment（1.8.0_131）
- nRF52840 DK（PCA10056）: プログラムの書込みに使用
- MDBT50Q Dongle（nRF52840）: プログラムの書込み先となるターゲット基板

### 動作確認準備

MDBT50Q Dongleを、nRF52840 DKと接続します。<br>
接続するピンの対応関係は以下の通りです。

|ピンの名前 |MDBT50Q Dongle | | nRF52840 DK|
|:--|:-:|:-:|:-:|
|0V |GND  | <-->  |GND|
|SWD IO |PIO  | <-->  |SWDIO|
|SWD Clock |PCLK  | -->  |SWDCLK|
|SWD IO Level |VDD  | -->  |VTG|

[注1] nRF52840 DK上の「P20」というコネクター（オスピン）に接続します。<br>
[注2] MDBT50Q Dongleの回路図はこちら（[FIDO2AUTH_001.pdf](https://github.com/diverta/onecard-fido/blob/master/FIDO2Device/pcb/FIDO2AUTH_001.pdf)）になります。

下図は実際に両者を接続した時のイメージになります。

<img src="assets/0004.png" width="480">

### 秘密鍵の準備

`Open Bootloader with DFU`を使用するためには、秘密鍵を生成する必要があります。

まずは、下記手順にしたがい、nrfutilを事前に導入します。<br>
　[nrfutil導入／利用手順](NRFUTIL.md)

その後、生成した秘密鍵／公開鍵を、以下の場所に保管します。

- 秘密鍵: `${HOME}/GitHub/onecard-fido/nRF5_SDK_v15.3.0/firmwares/dfu_private_key.pem`
- 公開鍵: `${HOME}/GitHub/onecard-fido/nRF5_SDK_v15.3.0/examples/dfu/dfu_public_key.c`（既存のものは上書きしてください）

以下は実行例になります。

```
MacBookPro-makmorit-jp:~ makmorit$ nrfutil keys generate private.pem
Generated private key and stored it in: private.pem
MacBookPro-makmorit-jp:~ makmorit$ cat private.pem
-----BEGIN EC PRIVATE KEY-----
MHcCAQEEIJ9v28odxjAcnz946PjPJRxJZjxFp7DCDZwgZmqUFJZloAoGCCqGSM49
AwEHoUQDQgAEFR1Ije3SUXSGCXGd18a4Xv0SpJUTPPR3Lm9juH80Uuydlb/zqE/3
UZ98WAmWorzvc8I6M2/gGXzP+MwYRy/1mQ==
-----END EC PRIVATE KEY-----
MacBookPro-makmorit-jp:~ makmorit$
MacBookPro-makmorit-jp:~ makmorit$ nrfutil keys display --key pk --format code private.pem --out_file public_key.c
MacBookPro-makmorit-jp:~ makmorit$ cat public_key.c

/* This file was automatically generated by nrfutil on 2019-08-12 (YY-MM-DD) at 10:56:29 */

#include "stdint.h"
#include "compiler_abstraction.h"

/** @brief Public key used to verify DFU images */
__ALIGN(4) const uint8_t pk[64] =
{
    0xec, 0x52, 0x34, 0x7f, 0xb8, 0x63, 0x6f, 0x2e, 0x77, 0xf4, 0x3c, 0x13, 0x95, 0xa4, 0x12, 0xfd, 0x5e, 0xb8, 0xc6, 0xd7, 0x9d, 0x71, 0x09, 0x86, 0x74, 0x51, 0xd2, 0xed, 0x8d, 0x48, 0x1d, 0x15,
    0x99, 0xf5, 0x2f, 0x47, 0x18, 0xcc, 0xf8, 0xcf, 0x7c, 0x19, 0xe0, 0x6f, 0x33, 0x3a, 0xc2, 0x73, 0xef, 0xbc, 0xa2, 0x96, 0x09, 0x58, 0x7c, 0x9f, 0x51, 0xf7, 0x4f, 0xa8, 0xf3, 0xbf, 0x95, 0x9d
};
MacBookPro-makmorit-jp:~ makmorit$ mv private.pem ${HOME}/GitHub/onecard-fido/nRF5_SDK_v15.3.0/firmwares/dfu_private_key.pem
MacBookPro-makmorit-jp:~ makmorit$ mv public_key.c ${HOME}/GitHub/onecard-fido/nRF5_SDK_v15.3.0/examples/dfu/dfu_public_key.c
MacBookPro-makmorit-jp:~ makmorit$
```

## ファームウェアの準備

NetBeansを導入のうえ、NetBeansでプロジェクトを作成し、ビルド＆書込みを行います。<br>
（NetBeans導入に関しては、[こちらのドキュメント](../../../Development/nRF52840/NETBEANS.md)をご参照）

### プロジェクト作成

NetBeansを起動し、ファイル--->新規プロジェクトを実行します。

<img src="assets/0004.png" width="480">

新規プロジェクト画面が表示されますので、一覧から「既存のソースを使用するC/C++プロジェクト」を選択し「次 >」をクリックします。

<img src="assets/0005.png" width="480">

下図のような画面に遷移しますので、以下のように設定します。

- 既存のソースを含むフォルダを指定 - サンプルアプリが格納されているフォルダー「examples/dfu/open_bootloader」を指定します。
下図の例では「/Users/makmorit/GitHub/onecard-fido/nRF5_SDK_v15.3.0/examples/dfu/open_bootloader」という文字列が設定されています。

- 「ツール・コレクション(T)」で「GNU Mac」を選択

- 「ビルド・アナライザの使用(S)」のチェックを外す

- 構成モードを選択 - 「カスタム(C)」をチェックします。

設定が完了したら「次 >」をクリックします。

<img src="assets/0006.png" width="480">

下図のような画面に遷移しますので、以下のように設定します。

- 「事前ビルド・ステップが必要」にチェック

- フォルダで実行(U) - サンプルアプリのサブフォルダー「pca10059_usb/armgcc」を指定します。<br>
下図の例では「/Users/makmorit/GitHub/onecard-fido/nRF5_SDK_v15.3.0/examples/dfu/open_bootloader/pca10059_usb/armgcc」という文字列が設定されています。

- 「カスタム・コマンド」にチェック
コマンド(O) - 「make」と入力します。

設定が完了したら「次 >」をクリックします。

<img src="assets/0017.png" width="480">

「4. ビルド・アクション」に遷移しますが、以降は「7. プロジェクトの名前と場所」に遷移するまではデフォルト設定のまま「次 >」をクリックします。

<img src="assets/0018.png" width="480">

「7. プロジェクトの名前と場所」に遷移したら、プロジェクト名(P)を「open_bootloader」から「open_bootloader_proj」に変更しておきます。<br>
（オリジナルのプロジェクト「open_bootloader」を上書きしたくないための措置です）

設定が完了したら「終了(F)」をクリックします。

<img src="assets/0019.png" width="480">

### メイクファイル修正とビルド

この手順では、プロジェクトファイル（GitHub管理ディレクトリー）とサンプルプログラムのディレクトリー構成が異なっているため、メイクファイルにNordic SDK 15.3.0の場所を認識させる必要があります。<br>
メイクファイルは以下のとおり修正します。

- 修正前
```
SDK_ROOT := ../../../../..
```

- 修正後
```
SDK_ROOT := $(HOME)/opt/nRF5_SDK_15.3.0
```

NetBeans上でメイクファイルを開き、直接編集のうえ、保存します。

<img src="assets/0020.png" width="600">

「プロジェクト(open_bootloader_proj)をビルド (F11)」を実行します。<br>
（またはF11キーを押下）

<img src="assets/0021.png" width="600">

しばらくするとビルドが完了し「ビルド SUCCESSFUL」と表示されれば、ビルドは成功です。

<img src="assets/0022.png" width="600">

### ファームウェアの書き込み

NetBeansを起動し、プロジェクト「open_bootloader_proj」を右クリックして「プロパティ」を実行します。

<img src="assets/0023.png" width="600">

プロジェクト・プロパティ画面が表示されます。

左ペインの「実行」をクリックしで、以下のように設定を変更します。

- コマンドの実行 - 「make flash_mbr flash」に変更します。

- 実行ディレクトリ - 実行するMakefileが配置されているディレクトリーが表示されていることを確認します。
下図の例では、`../open_bootloader/pca10059_usb/armgcc`という文字列が設定されています。

変更が完了したら「適用」と「OK」をクリックして、いったんプロジェクト・プロパティ画面を閉じます。

<img src="assets/0024.png" width="480">

「プロジェクト(open_bootloader_proj)を実行 (F6)」を実行します。<br>
（またはF6キーを押下）

<img src="assets/0025.png" width="600">

プログラムが自動的に書き込まれ、nRF52840上でアプリケーションが実行されます。<br>
NetBeansの右下部のコンソールには「実行 FINISHED; 終了値0」と表示されます。

<img src="assets/0026.png" width="600">

以上で、ファームウェアの準備は完了となります。

## 動作確認手順

まず、nRF52840とPCを、USBケーブル（microB）で接続します。<br>
そして、ターミナルでUARTプリントを表示させたのち、nRF52840ボード上のリセットボタンを押下します。<br>
ほどなく、`UART started.`という文字列が表示されるのを確認します。

<img src="assets/0002.png" width="640">

その後、Android端末に導入した`nRF UART v2.0`というアプリを使用して、データの送受信を行います。<br>
下図のように「QWERTY」とテキストを送信してみます。

<img src="assets/0001.jpg" width="240">

nRF52840のデバッグプリントから同じく「QWERTY」とテキストが表示されれば、動作確認は完了です。

<img src="assets/0003.png" width="640">
