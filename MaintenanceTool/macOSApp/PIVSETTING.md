# PIV機能の基本設定手順

## 概要

[FIDO認証器管理ツール](README.md)を使用して、[MDBT50Q Dongle](../../FIDO2Device/MDBT50Q_Dongle/README.md)に対し、PIV機能に最低限必要な基本設定を行う手順を掲載します。

## ソフトウェアのバージョン確認

PIV機能は、[CCIDインターフェース](../../CCID/README.md)という仕組みを使用しております。<br>
この仕組みを使用するためには、管理ツール、ファームウェア共に、必要バージョン以降である必要があります。

#### 管理ツールのバージョン確認
まずは[インストール手順](INSTALLPRG.md)を参照し、管理ツールをmacOSにインストールします。<br>
次に、下記手順で管理ツールのバージョン確認を行い、<b>Version 0.1.34以降</b>であるかどうか確認します。

管理ツールのメニュー「Preferences」を選択し、ツール設定画面を開きます。

<img src="assets03/0001.jpg" width="400">

ツール設定画面のタブ「バージョン」を選択し、バージョンを確認してください。<br>
（下記例では「Version 0.1.35」となっております）

<img src="assets05/0030.jpg" width="400">

#### ファームウェアのバージョン確認
続いて、下記手順でファームウェアのバージョン確認を行い、<b>0.2.13以降</b>であるかどうか確認します。

[MDBT50Q Dongle](../../FIDO2Device/MDBT50Q_Dongle/README.md)をPCのUSBポートに装着した後、管理ツールのメニュー「Test-->USB-->バージョン情報取得」を選択します。

<img src="assets05/0031.jpg" width="400">

管理ツール下部のメッセージ欄に表示される、ファームウェアのバージョンを確認してください。<br>
（下記例では「0.3.5」となっております）

<img src="assets07/0002.jpg" width="400">

## PIV機能設定画面の表示

PIV機能の設定は「PIV機能設定画面」上で行います。

まずは管理ツールを起動し、USBポートに[MDBT50Q Dongle](../../FIDO2Device/MDBT50Q_Dongle/README.md)を装着します。<br>

<img src="assets/0028.jpg" width="400">

管理ツール画面下部のメッセージ欄に「USB HIDデバイスに接続されました。」と表示されることを確認したら、管理ツール画面の「PIV機能設定」ボタンをクリックします。

<img src="assets05/0001.jpg" width="400">

ホーム画面の上に、PIV機能設定画面がポップアップ表示されます。

<img src="assets05/0002.jpg" width="400">

以後の設定作業は、すべてこの「PIV機能設定画面」で実行します。

## 基本設定の実行

PIV機能に最低限必要な基本設定、すなわちID設定、および鍵・証明書ファイルのインストールを実行します。

### ID設定の実行

PIV機能設定画面の「ID設定を実行」ボタンをクリックします。

<img src="assets05/0003.jpg" width="400">

下記のような確認ダイアログが表示されますので、Yesボタンをクリックします。

<img src="assets05/0004.jpg" width="400">

ID設定処理が実行されます。<br>
程なく、下図のようなメッセージがポップアップ表示され、処理が完了します。

<img src="assets05/0005.jpg" width="400">

設定されたIDは「PIV設定情報取得画面」で確認できます。<br>
PIV機能設定画面の「設定情報を参照」ボタンをクリックします。

<img src="assets05/0006.jpg" width="400">

PIV設定情報取得画面に、下図の「CHUID」「CCC」が設定されていることが確認できます。

<img src="assets05/0007.jpg" width="400">

以上で、ID設定の実行は完了です。

### 鍵・証明書ファイルのインストール

PIV機能では、FIDO機能と同様、鍵・証明書ファイルを[MDBT50Q Dongle](../../FIDO2Device/MDBT50Q_Dongle/README.md)に導入する必要があります。

導入が必要な鍵・証明書は、以下の３セットになります。<br>
いずれも「PEM形式」の鍵・証明書ファイル（テキストファイル）をご用意ください。

- PIV認証用
- 電子署名用
- 管理機能用

以下の手順により、３セットの鍵・証明書をすべてインストールします。

#### インストール手順

まずはラジオボタンから、インストールする鍵・証明書の種別を選択します。<br>
その後、鍵ファイルのパスを選択します。

鍵ファイル欄右側の「参照」ボタンをクリックします。

<img src="assets05/0008.jpg" width="400">

ファイル参照ダイアログから、該当の鍵ファイル（PEM形式）を選択し「選択」ボタンをクリックします。

<img src="assets05/0009.jpg" width="400">

鍵ファイル欄に、選択された鍵ファイルのパスが表示されます。<br>
（マウスカーソルを上から当てると、下図のようにフルパス名称が小さくToolTip表示されます）

<img src="assets05/0010.jpg" width="400">

同様に、証明書ファイルのパスも選択します。

<img src="assets05/0011.jpg" width="400">

鍵ファイル、証明書ファイルの両方を選択したら、下部の認証情報欄に、PIV機能で使用するPIN番号を入力します。<br>
PIN番号は初期状態では「123456」となっております（必要に応じ変更可能です）。

PIN番号を入力したら、下部の「鍵・証明書ファイルのインストール」ボタンをクリックします。

<img src="assets05/0012.jpg" width="400">

下記のような確認ダイアログが表示されますので、Yesボタンをクリックします。

<img src="assets05/0013.jpg" width="400">

鍵・証明書ファイルのインストール処理が実行されます。<br>
程なく、下図のようなメッセージがポップアップ表示され、処理が完了します。

<img src="assets05/0014.jpg" width="400">


#### 確認手順

インストールされた証明書は「PIV設定情報取得画面」で確認できます。<br>
PIV設定情報取得画面に、下図の「Slot for PIV authenticate(PIV認証用)」「Slot for signature(電子署名用)」「Slot for key management(管理機能用)」の証明書３点が設定されていることが確認できます。

<img src="assets05/0015.jpg" width="400">

以上で、鍵・証明書ファイルのインストールは完了です。

## その他の各種設定

前項までの手順により、PIV機能に最低限必要な基本設定が完了しますが、その他にもPIN番号変更等のオプション機能を用意しております。<br>
詳細につきましては、別ドキュメント「[PIV機能の各種設定手順](../../MaintenanceTool/macOSApp/PIVSETTING_OPT.md)」をご参照願います。
