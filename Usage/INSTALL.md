# 鍵・証明書インストール手順（macOS版）

BLE U2Fサービスを動作させるためには、秘密鍵と署名済み証明書が必要になります。

秘密鍵と署名済み証明書を、[U2F管理ツール](../U2FMaintenanceTool/)を使用してインストールし、動作確認（ヘルスチェック）を実行するまでの手順を、以下に掲載いたします。

## U2F管理ツールの準備

[U2FMaintenanceTool.pkg](../U2FMaintenanceTool/macOSApp/U2FMaintenanceTool.pkg) をGitHubからダウンロード後、インストールを実行します。

インストール後、アプリケーション・フォルダーに作成された「U2FMaintenanceTool.app」をダブルクリックすると、U2F管理ツール画面が起動します。

## 鍵・証明書の作成

U2F管理ツールを使用して、以下の手順で、秘密鍵ファイル(.pem)、証明書ファイル(.crt)を作成します。

### 秘密鍵ファイル(.pem)の作成

U2F管理ツールのファイル作成メニューから「鍵ファイル作成」を実行します。

<img src="assets/0001.png" width="450">

ファイル作成ダイアログが表示されますので、出力先のディレクトリー、ファイル名を指定して「作成」をクリックします。

<img src="assets/0002.png" width="600">

秘密鍵ファイル作成処理がスタートします。

「鍵ファイル作成が成功しました。」というメッセージが表示されれば、秘密鍵ファイル(.pem)作成は完了です。

<img src="assets/0003.png" width="450">

### 証明書ファイル(.crt)の作成

署名済み証明書は、本来、ベリサインやグローバルサインのようなパブリック認証局に署名／作成を依頼するのですが、その手順につきましては、ここでは触れません。

ここでは、開発用に使用できる「自己署名証明書」の作成手順について、掲載いたします。

#### 証明書要求ファイル(.csr)の作成

先ほど作成した秘密鍵ファイル(.pem)を入力とし、証明書要求ファイル(.csr)を生成します。

U2F管理ツールのファイル作成メニューから「証明書要求ファイル作成」を実行します。

<img src="assets/0004.png" width="450">

証明書要求ファイル(CSR)作成ダイアログが表示されます。<br>
画面上の項目に、使用する鍵ファイル、Webサイトや事業者に関する情報を入力して「作成」をクリックします。

<img src="assets/0005.png" width="500">

ファイル作成ダイアログが表示されますので、出力先のディレクトリー、ファイル名を指定して「作成」をクリックします。

<img src="assets/0006.png" width="600">

証明書要求ファイル作成処理がスタートします。

「証明書要求ファイル作成が成功しました。」というメッセージが表示されれば、証明書要求ファイル(.csr)作成は完了です。

<img src="assets/0007.png" width="450">

#### 証明書要求ファイルから、自己署名証明書を作成

証明書要求ファイル(.csr)を入力とし、X.509を使用して署名した自己署名証明書ファイル(.crt)を生成します。<br>
出力形式は、秘密鍵(PEM形式)との混同を回避するため、DER形式で出力されます。

U2F管理ツールのファイル作成メニューから「自己署名証明書ファイル作成」を実行します。

<img src="assets/0008.png" width="450">

自己署名証明書ファイル(CRT)作成ダイアログが表示されます。<br>
画面上の項目に、使用する証明書要求ファイル、鍵ファイル、証明書有効期間（日数）を入力して「作成」をクリックします。

<img src="assets/0009.png" width="500">

ファイル作成ダイアログが表示されますので、出力先のディレクトリー、ファイル名を指定して「作成」をクリックします。

<img src="assets/0010.png" width="600">

自己署名証明書ファイル作成処理がスタートします。

「自己署名証明書ファイル作成が成功しました。」というメッセージが表示されれば、自己署名証明書ファイル(.csr)作成は完了です。

<img src="assets/0011.png" width="450">

以下の図のように作成された鍵ファイル、証明書ファイルを、One Cardにインストールして使用することになります。

<img src="assets/0012.png" width="500">

以上で、鍵・証明書の作成は完了です。

## 鍵・証明書のインストール

U2F管理ツールを使用して、秘密鍵ファイル(.pem)、証明書ファイル(.crt)を、One Cardにインストールします。

U2F管理ツール（U2FMaintenanceTool.app）を起動します。<br>
表示された画面の「鍵・証明書・キーハンドル消去」ボタンをクリックします。

<img src="../assets/0027.png" width="500">

確認ダイアログが表示されますので「はい」をクリックします。

<img src="../assets/0077.png" width="500">

One Card側の処理が成功すると「鍵・証明書・キーハンドル削除処理が成功しました。」と表示されます。

<img src="../assets/0028.png" width="500">

続いて、秘密鍵ファイル(.pem)、証明書ファイル(.crt)をそれぞれ「参照」ボタンをクリックして選択します。

<img src="../assets/0029.png" width="500">

U2F管理ツール画面の「鍵・証明書ファイルのインストール」ボタンをクリックします。

<img src="../assets/0030.png" width="500">

One Card側の処理が成功すると「鍵・証明書インストールが成功しました。」と表示されます。

<img src="../assets/0031.png" width="500">

これで、鍵・証明書のインストールは完了です。

## U2F管理ツールによる動作確認（ヘルスチェック）

One Cardにインストールされた秘密鍵と署名済み証明書を使用し、U2F管理ツールを使用して動作確認（ヘルスチェック）を実行することができます。

U2F管理ツール（U2FMaintenanceTool.app）を起動します。<br>
表示された画面の「ヘルスチェック実行」ボタンをクリックします。

<img src="../assets/0032.png" width="500">

One Card側で処理が進み、ほどなくOne Card上の右端のLEDが<font color=ff0000><b>点灯</b></font>します。<br>
（ユーザー所在確認を求めるため、One Card側の処理が一時的に中断されます）

ここでMAIN SWを１回押します。

<img src="../assets/0078.png" width="500">

点灯していたLEDが<b>消灯</b>し、One Card側のヘルスチェック処理が再開されます。

<img src="../assets/0079.png" width="500">

One Card側の処理が成功すると「ヘルスチェックが成功しました。」と表示されます。

<img src="../assets/0034.png" width="500">

これでヘルスチェックは完了です。
