<html>
<head>
    <title>U2F Test Server</title>
    <script src="/u2f-api.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/redmond/jquery-ui.min.css" type="text/css" />
    <script type="text/javascript">
    $(function() {
        $('input[type="button"]').button();
    });

    // U2F BLEデバイスの参照を保持
    var bleU2fDevice;


    function doFinishEnroll(enrollData, enrollResponse) {
        // U2F Registerの結果をU2Fサーバーに通知
        $.get('/enrollFinish', {
            browserData:enrollResponse.clientData,
            enrollData:enrollResponse.registrationData,
            challenge:enrollData.challenge,
            sessionId:enrollData.sessionId
        })
        .done(function(enrollFinishResultHTML) {
            document.getElementById('status').innerHTML =
                enrollFinishResultHTML;
        })
        .fail(function(xhr, status) {
            document.getElementById('status').innerHTML =
                "Finish enroll failed: " + status;
        });

        // BLE U2Fデバイス参照が取得できたら、
        // BLEデバイス情報を参照(for debug)
        console.log("Reference of bleU2fDevice", bleU2fDevice);
    }

    function doStartEnroll(enrollData) {
        // アプリケーション情報を使用し、
        // U2F Registrationを実行
        // 注意：
        //   BLE U2Fヘルパー疎通が未済のため、
        //   YubiKey NEOを台本板にして動作確認しています
        //
        //   後日、bleU2fDeviceを使った処理と置き換える予定です。
        //
        u2f.register(enrollData.appId, [enrollData], [],
            function (registerResponse) {
                var errorCode = registerResponse.errorCode;
                if (errorCode) {
                    document.getElementById('status').innerHTML =
                        "Failed. Error code: " + errorCode;
                    return;
                }
                console.log("U2F Register response", registerResponse);

                // U2F Registrationの結果をU2Fサーバーへ返却
                doFinishEnroll(enrollData, registerResponse);
            }, 60
        );

        document.getElementById('status').innerHTML =
            "Waiting for user touch";
    }

    function doProcessEnroll() {
        // Register U2F Authenticatorボタン押下時の処理
        //
        // U2Fサーバーにアクセスし、
        // U2Fトークン登録処理(Enroll)で使用する
        // アプリケーション情報を取得
        $.get('/enrollData.js', {userName:'userName'})
        .done(function(enrollDataJavaScript) {
            // 取得したアプリケーション情報を
            // 連想配列 enrollData に格納
            eval(enrollDataJavaScript);
            console.log("U2F Register request data", enrollData);

            // アプリケーション情報を使用し、
            // U2F Registrationを実行
            doStartEnroll(enrollData);
       })
       .fail(function(xhr, status) {
            document.getElementById('status').innerHTML =
                "Starting enroll failed: " + status;
       });
    }


    function doFinishSign(signData, authResponse, sessionId) {
        // U2F Authenticationの結果をU2Fサーバーに通知
        $.get('/signFinish', {
            browserData:authResponse.clientData,
            appId:signData.appId,
            challenge:signData.challenge,
            signData:authResponse.signatureData,
            sessionId:sessionId
        })
        .done(function(signFinishResultHTML) {
            document.getElementById('status').innerHTML =
                signFinishResultHTML
        })
        .fail(function(xhr, status) {
            document.getElementById('status').innerHTML =
                "Finish sign failed: " + status;
        });

        // BLE U2Fデバイス参照が取得できたら、
        // BLEデバイス情報を参照(for debug)
        console.log("Reference of bleU2fDevice", bleU2fDevice);
    }

    function doStartSign(signData) {
        // アプリケーション情報を使用し、
        // U2F Authenticationを実行
        // 注意：
        //   BLE U2Fヘルパー疎通が未済のため、
        //   YubiKey NEOを台本板にして動作確認しています
        //
        //   後日、bleU2fDeviceを使った処理と置き換える予定です。
        //
        var sessionIdList = {};
        signData.registeredKeys.forEach(function(registeredKey) {
            sessionIdList[registeredKey.keyHandle] = registeredKey.sessionId;
        });

        u2f.sign(signData.appId, signData.challenge, signData.registeredKeys,
            function(authResponse) {
                var errorCode = authResponse.errorCode;
                if (errorCode) {
                    document.getElementById('status').innerHTML = 
                        "Failed. Error code: " + errorCode;
                    return;
                }
                console.log("U2F Authentication response", authResponse);

                // キーハンドルに対応するセッションIDを取得
                var sessionId = sessionIdList[authResponse.keyHandle];

                // U2F Authenticationの結果をU2Fサーバーへ返却
                doFinishSign(signData, authResponse, sessionId);
            }, 60
        );

        document.getElementById('status').innerHTML =
            "Waiting for user touch";
    }

    function doProcessSign() {
        // Test Authenticationボタン押下時の処理
        //
        // U2Fサーバーにアクセスし、
        // U2Fトークン認証処理(Sign)で使用する
        // アプリケーション情報を取得
        $.get('/signData.js', {userName:'userName'})
        .done(function(signDataJavaScript) {
            // 取得したアプリケーション情報を
            // 連想配列 signData に格納
            eval(signDataJavaScript);
            console.log("U2F Authentication request data", signData);

            // アプリケーション情報を使用し、
            // U2F Authenticationを実行
            doStartSign(signData);
       })
       .fail(function(xhr, status) {
            document.getElementById('status').innerHTML =
                "Starting sign failed: " + status;
       });
    }


    function doProcess(processType) {
        document.getElementById('status').innerHTML =
            "Requesting BLE U2F device...";

        // Web Bluetooth APIを実行
        navigator.bluetooth.requestDevice({acceptAllDevices:true})
        .then(device => {
            // BLE U2Fデバイスの参照を保持
            bleU2fDevice = device;

            // 以降の処理を振り分け
            if (processType == 'enroll') {
                doProcessEnroll();
            } else if (processType == 'sign') {
                doProcessSign();
            }
        })
        .catch(error => {
            // BLE U2Fデバイス参照が取得できない場合
            document.getElementById('status').innerHTML =
                "Requesting BLE U2F device failed: " + error;
        });
    }
    </script>
</head>
<body>
    <h1>U2F Test Server</h1>
    <div>
        <input type="button" value="Register U2F Authenticator" onClick="doProcess('enroll');"/>
        <div>&nbsp;</div>
        <input type="button" value="Test Authentication" onClick="doProcess('sign');"/>
    </div>
    <div>&nbsp;</div>
    <div id="status"></div>
</body>
</html>
