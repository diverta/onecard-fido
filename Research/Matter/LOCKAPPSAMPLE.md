# nRF5340 Lockアプリの概要

nRF5340を使用し、Threadネットワーク内で稼働するLock（施錠）アプリを実装するサンプルです。

## nRF Connect Lockサンプルアプリ

nRF Connect Lockサンプルアプリ（CHIPデバイス）は、1本の基本的なボルトでドア施錠するデバイス（CHIPコントローラーデバイス）をリモート制御するサンプルになります。

ボタンを使用してロックとデバイス状態の変更をテストし、LEDによりこれらの変更状態を表示します。<br>
このサンプルアプリは、独自アプリケーションを作成するためのリファレンスとして使用できます。

このサンプルアプリは、CHIPとNordic SemiconductorのnRFConnect SDKをベースとしています。<br>
低電力の802.15.4 Threadネットワークを介したドアロックのリモートアクセス／制御をサポートしています。<br>
（訳者注：<b>Thread</b> ＝ IoT無線規格のひとつ）

このサンプルアプリは、CHIPアクセサリとして動作します。<br>
このサンプルアプリデバイスは、既存のCHIPネットワークとペアリングでき、そのネットワークを通じて制御できます。

#### 概要

このサンプルアプリは、Nordic SemiconductorのnRF Connect SDKとZephyr RTOSをベースとしたnRF Connect CHIPプラットフォームで実行されます。<br>
CHIPプラットフォームの構造と依存関係の詳細については、nRF Connect CHIPプラットフォームの概要をご覧ください。<br>
https://github.com/project-chip/connectedhomeip/blob/master/docs/guides/nrfconnect_platform_overview.md

Lockアプリケーションを実行するCHIPデバイスは、Threadプロトコルを介してCHIPコントローラーデバイスによって制御されます。<br>
デフォルトでは、CHIPデバイスではThreadが稼働していない（無効になっている）ため、CHIPコントローラーとペアリングして、CHIPに関する構成を取得する必要があります。<br>
完全な通信を確立する前に必要な、いくつかのアクションを以下に説明します。

このサンプルアプリには、テストモードも付属しており、ボタン押下により、デフォルト設定でThreadを手動開始できます。<br>
ただし、このモードは、デバイスがCHIPコントローラーおよび他デバイスと通信できることを保証するものではありません。

#### BLEアドバタイズ

このサンプルアプリでは、デバイスをCHIPネットワークにコミッショニングするには、BLEを介してデバイスを検出できる必要があります。<br>
セキュリティ上の理由から、デバイスの電源を入れた後、ボタン4を押してBLEアドバタイズを手動で開始する必要があります。

#### BLE rendezvous

このサンプルアプリにおいて、コミッショニング処理（[`rendezvous`](https://github.com/project-chip/connectedhomeip/tree/master/examples/lock-app/nrfconnect#bluetooth-le-rendezvous)と呼ばれる）は、CHIPデバイスとCHIPコントローラーの間でBLEを介して実行されます。<br>
（訳者注：BLE NFCペアリングの転用）

ここで、CHIPコントローラーはコミッショナーの役割を果たします。

`rendezvous`を開始するには、コントローラーはCHIPデバイスからコミッショニング情報を取得する必要があります。<br>
コミッショニング情報のデータ内容は、QRコードを使用してエンコードされ、NFCタグエミュレーションを使用し共有されます。<br>
（訳者注：サンプルアプリのプログラムは、データ内容をUARTコンソールにも出力するようです）

セキュリティ上の理由から、デバイスの電源を入れた後、ボタン4を押しNFCタグエミュレーションを手動で開始する必要があります。

#### Threadプロビジョニング

ランデブー処理の最終工程として、プロビジョニング操作では、CHIPコントローラーからCHIPデバイスへのThreadネットワーククレデンシャルの送信が行われます。<br>
その結果、デバイスはThreadネットワークに参加し、ネットワーク内の他のThreadデバイスと通信できるようになります。

## ユーザーインターフェース

以下のユーザーインターフェイス要素により、デバイスの状態を制御／監視できます。

|#|コンポーネント|説明|備考|
|:---:|:---|:---|:---|
|1|<b>LED1</b>|プロビジョン／接続状態を表示||
|2|<b>LED2</b>|施錠／解錠状態を表示||
|3|<b>ボタン1</b>|リセット／DFU処理を実行||
|4|<b>ボタン2</b>|施錠／解錠を実行||
|5|<b>ボタン3</b>|Threadをテストモードで開始||
|6|<b>ボタン4</b>|NFCエミュレーション／BLEアドバタイズ開始|BLE NFCペアリングの準備|
|7|<b>USBポート</b>|ログ取得／コマンド実行時に使用|SEGGER J-Linkを経由|
|8|<b>NFCポート</b>|ペアリング時のデータ送受信に使用|要：アンテナ実装|

#### LED1
デバイスのプロビジョン／接続状態を表示します。

- <b>ショートフラッシュOn</b><br>（50ミリ秒On／950ミリ秒Off）<br>
サンプルアプリの接続を待機している状態です。<br>
デバイスはプロビジョニングされていない（ペアリングされていない）状態です。

- <b>高速点滅</b><br>（100ミリ秒On／100ミリ秒Off）<br>
サンプルアプリはBLE接続されていますが、デバイスはプロビジョニングされていない状態です。

- <b>ショートフラッシュOff</b><br>（950ミリ秒On／50ミリ秒Off）<br>
デバイスのプロビジョニングは完了していますが、Threadネットワーク／サービスには未接続です。

- <b>連続点灯</b><br>
デバイスは完全にプロビジョニングされ、Threadネットワーク／サービスに接続されています。

#### LED2
施錠／解錠状態を表示します。

- <b>連続点灯</b><br>
ボルトが伸び、ドアがロックされている状態です。

- <b>消灯</b><br>
ボルトが引っ込められ、ドアのロックが解除された状態です。

- <b>高速点滅</b><br>（2秒の間に100ミリ秒On／100ミリ秒Off）<br>
シミュレートされたボルトが施錠中または解錠中の状態です。

#### ボタン1

- <b>長押し（6秒間）</b><br>
デバイスを工場出荷時状態に戻すためのリセット（factory reset）を開始します。<br>
6秒以内にボタンを離した場合、リセット処理は行われません。<br>
リセット処理が開始されると、LED1〜4が同時点滅します。

- <b>短押し</b><br>
ファームウェアの更新処理（OTA software update）を開始します。<br>
この機能はデフォルトで無効になっていますが、別ドキュメント「[ Building with Device Firmware Upgrade support](https://github.com/project-chip/connectedhomeip/tree/master/examples/lock-app/nrfconnect#building-with-device-firmware-upgrade-support)」に記載の手順に従い、有効化することができます。

#### ボタン2
ボタンを１回押すたびに、施錠または解錠ができます。

#### ボタン3
ボタンを１回押すと、デフォルト構成を使用し、テストモードでThreadネットワークが開始されます。

#### ボタン4
ボタンを１回押すと、NFCタグのエミュレーションが開始され、BLEアドバタイズがあらかじめ指定された時間内実行されます。

#### USBポート
SEGGER J-Link経由で、デバイスからログを取得したり、コマンド（[command line interface](https://github.com/project-chip/connectedhomeip/blob/master/docs/guides/nrfconnect_examples_cli.md)）を使用してデバイスと通信したりできます。

#### NFCポート
ペアリング処理（[rendezvous](https://github.com/project-chip/connectedhomeip/tree/master/examples/lock-app/nrfconnect#bluetooth-le-rendezvous)）を開始する際、CHIPデバイスから設定等のデータを、NFCを経由して送受信できます。<br>

## ご参考：DFUについて

このサンプルアプリは、セキュアブートローダーを使用し、BLEを使用して無線DFUを実行するために使用するように構成できます。

#### DFU
（`Device Firmware Upgrade`）

このサンプルアプリでは、無線DFU機能を有効にすることができます。<br>
DFU処理では、新しいファームウェアイメージをホストしているデバイスが、BLEトランスポートと`Simple Management Protocol`を使用し、ファームウェアイメージをCHIPデバイスに送信します。<br>
次に、MCUbootブートローダーという仕組みが、古いファームウェアイメージを新しいファームウェアイメージに置き換えます。

#### ブートローダー

MCUbootは、異なるバージョンのファームウェアイメージを交換し、デバイスのDFU処理で使用できる適切なバイナリーを生成するために使用される安全なブートローダーです。

ブートローダーには、DFU中にアプリケーションイメージを置き換えるためのフラッシュメモリ領域が必要です。<br>
Nordicデバイスは、この目的のために外部メモリチップを使用します。<br>
メモリチップは、QSPIバスを介してマイクロコントローラと通信します。

このサンプルアプリでMCUbootとフラッシュの設定を変更する方法については、`Building with Device FirmwareUpgrade`のサポートセクションを参照してください。

#### SMP
（`Simple Management Protocol`）

SMPは、アプリケーションイメージ管理を含むデバイス管理の目的で使用される基本的な転送方法です。<br>
SMPは、Bluetooth LE、UDP、シリアルUSB / UARTなどのさまざまなトランスポートの使用をサポートしています。<br>
このサンプルアプリでは、CHIPデバイスはSMPサーバーを実行し、BLEトランスポートを使用してアプリケーション更新イメージをダウンロードします。<br>
このサンプルアプリでSMPを有効にし、DFUの目的で使用する方法については「DFUを使用したビルドのサポート」セクションを参照してください。
