# OpenPGPを使用したファイル暗号／復号化手順

最終更新日：2022/2/21

[MDBT50Q Dongle](../../FIDO2Device/MDBT50Q_Dongle/README.md)のOpenPGPカードエミュレーション機能を使用し、Windows上でファイルを暗号化／復号化をする手順について、以下に掲載いたします。

## 想定局面

<img src="assets03/0021.jpg" width="600"><br>
<img src="assets03/0022.jpg" width="600">

## （１）秘密鍵／公開鍵生成

ファイルを暗号化して提供／受領を行うために必要となる、PGP秘密鍵／公開鍵を生成します。

### ファイル受領者の手順

暗号化されたファイルを受け取るユーザー（ファイル受領者）は、秘密鍵と公開鍵をペアで生成します。<br>
このうち、秘密鍵は、[MDBT50Q Dongle](../../FIDO2Device/MDBT50Q_Dongle/README.md)に格納します。

#### 専用ソフトウェアをインストール

管理ツール、GPGツール群「[Gpg4win](https://www.gnupg.org)」を、PCにインストールします。<br>
具体的な手順につきましては、下記手順書をご参照願います。

- [管理ツールインストール手順](../../MaintenanceTool/dotNET/INSTALLPRG.md)
- [Gpg4winインストール手順](../../CCID/OpenPGP/GPGINSTWIN.md)

#### 秘密鍵／公開鍵を生成、秘密鍵を移動

Windowsにインストールした管理ツールにより、秘密鍵／公開鍵を生成します。

生成した秘密鍵は、[MDBT50Q Dongle](../../FIDO2Device/MDBT50Q_Dongle/README.md)に格納し、PCには配置しないようにします。<br>
一方、公開鍵は、公開鍵ファイル（`public_key.pgp`）として管理ツールから出力されます。

具体的な手順につきましては、別ドキュメント<b>「[PGP鍵インストール手順書](../../MaintenanceTool/dotNET/PGPKEYINST.md)」</b>をご参照願います。

#### 公開鍵を送付

ファイル受領者は、ファイルを暗号化し引き渡す方となるユーザー（ファイル提供者）に、公開鍵ファイルを電子メールなどで送付します。

### ファイル提供者の手順

ファイルを暗号化し引き渡すユーザー（ファイル提供者）は、受領した公開鍵を、PCに格納します。

#### 専用ソフトウェアをインストール

GPGツール群「[Gpg4win](https://www.gnupg.org)」を、PCにインストールします。<br>
具体的な手順につきましては、別ドキュメント<b>「[Gpg4winインストール手順](../../CCID/OpenPGP/GPGINSTWIN.md)」</b>をご参照願います。

#### 公開鍵を受領

ファイル提供者は、ファイル受領者から公開鍵を電子メールなどで受領します。<br>
受信した公開鍵ファイルは、任意のフォルダーに保存します。

<img src="assets03/0001.jpg" width="400">

## （２）ファイルの暗号化／復号化

ファイルをPGP公開鍵により暗号化して提供し、受領した暗号化ファイルをPGP秘密鍵により復号化します。

### ファイル提供者の手順

ファイルを暗号化し引き渡すユーザー（ファイル提供者）は、ファイルをPGP公開鍵により暗号化して提供します。<br>
以下は具体的な手順になります。

#### 公開鍵をインポート

暗号化するために必要な公開鍵ファイル（`public_key.pgp`）を、GPGツールを使用してインポートします。<br>
公開鍵ファイルを右クリックして「More GpgEX options-->Import keys」を選択します。

<img src="assets03/0002.jpg" width="450">

公開鍵が、GPGツールによりインポートされます。<br>
下図のようなポップアップ画面が表示されるので「OK」ボタンをクリックして閉じます。

<img src="assets03/0003.jpg" width="450">

GUIアプリ「Kleopatra」を使うと、先ほどの公開鍵がインポートされていることを確認できます。<br>
画面の一覧に、インポートされた公開鍵が表示されています。

<img src="assets03/0004.jpg" width="450">

#### ファイルを暗号化

「`README.md`」というファイルを暗号化するものとします。<br>
`README.md`を右クリックして「More GpgEX options-->Encrypt」を選択します。

<img src="assets03/0005.jpg" width="450">

下図のような画面が表示されます。<br>
「Encrypt for others」の右横にあるアイコンをクリックします。

<img src="assets03/0006.jpg" width="360">

宛て先を選択するポップアップが表示されます。<br>
先ほどインポートした公開鍵を選択し「OK」をクリックします。

<img src="assets03/0007.jpg" width="360">

先ほどインポートした公開鍵が選択されていることを確認し、画面右下の「暗号化」ボタンをクリックすると、ファイルの暗号化が開始されます。

<img src="assets03/0008.jpg" width="360">

暗号化が完了しました。<br>
完了ボタンをクリックし、画面を閉じます。

<img src="assets03/0009.jpg" width="360">

暗号化ファイル「`README.md.gpg`」が生成されたのを確認します。

<img src="assets03/0010.jpg" width="450">

以上で、公開鍵によるファイルの暗号化は完了です。

#### ファイルを提供

暗号化されたファイルは、電子メールなどで送信します。

<img src="assets03/0011.jpg" width="400">

### ファイル受領者の手順

暗号化されたファイルを受け取るユーザー（ファイル受領者）は、受領したファイルをPGP秘密鍵を使用して復号化します。<br>
以下は具体的な手順になります。

#### ファイルを受領

ファイル受領者は、暗号化されたファイルを、ファイル提供者から電子メールなどで受領します。<br>
受信した暗号化ファイル（`README.md.gpg`）は、任意のフォルダーに保存します。

<img src="assets03/0013.jpg" width="330">

#### 公開鍵をインポート

復号化側となるファイル受領者も、前述の手順により、GPGツールを使用して公開鍵のインポートを行う必要があります。[注1]<br>
ファイル提供者（暗号化側）と同じ公開鍵ファイル（`public_key.pgp`）を使用することになります。

[注1]「[PGP鍵インストール手順書](../../MaintenanceTool/dotNET/PGPKEYINST.md)」による鍵インストール処理を実行すると、鍵インストール完了時、PGP秘密鍵に対応するPGP公開鍵ファイル（`public_key.pgp`）が生成されます。ただしこれだけでは、MDBT50Q DongleにインストールされたPGP秘密鍵がWindowsに認識されないため、GPGツールによりPGP公開鍵ファイルをWindows上にインポートし、MDBT50Q Dongle上のPGP秘密鍵と紐づける（＝WindowsにPGP秘密鍵の格納場所を認識させる）必要があります。

#### 秘密鍵を紐付け

秘密鍵のあるMDBT50Q Dongleを、PCのUSBポートに装着することにより、前述のインポートされた公開鍵と、秘密鍵が紐付けられます。

<img src="assets03/0012.jpg" width="400">

Windows環境では、MDBT50Q DongleをPCに装着した時点でOpenPGP機能が稼働しているので、MDBT50Q Dongleに格納された秘密鍵を使用することが出来るようになります。

#### ファイルを復号化

暗号化されたファイル「`README.md.gpg`」をGPGツールにより復号化します。<br>
`README.md.gpg`を右クリックして「More GpgEX options-->Decrypt」を選択します。

<img src="assets03/0014.jpg" width="450">

下図のような画面が表示されます。<br>
デフォルトのPIN番号「`123456`」[注2]を入力し、画面右下の「OK」ボタンをクリックすると、ファイルの復号化が開始されます。

<img src="assets03/0015.jpg" width="450">

復号化が完了しました。<br>
「すべて保存」ボタンをクリックし、画面を閉じます。

<img src="assets03/0016.jpg" width="450">

暗号化前のファイル「`README.md`」が生成されたのを確認します。

<img src="assets03/0017.jpg" width="450">

以上で、秘密鍵によるファイルの復号化は完了です。

[注2] PIN番号は初期状態では「`123456`」となっております。変更したい場合は、別ドキュメント「[OpenPGP機能の各種設定手順](../../MaintenanceTool/dotNET/PGPSETTING_OPT.md)」をご参照願います。
