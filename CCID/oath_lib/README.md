# OATHカードエミュレーション

最終更新日：2022/11/21

## 概要
OATHカードと同等の機能（OATHカードエミュレーション機能）を、[本プロジェクトで製作された認証器](../../FIDO2Device)（以下、単に「認証器」と言います）上に実装するためのモジュールです。

プラットフォーム（nRF Connect SDK）に依存する部分と、依存しない部分に分かれています。

## 前提要件

#### 専用CCIDドライバーのインストール（macOSのみ）

OpenPGPカードエミュレーション機能は、USB CCIDインターフェース上で動作します。<br>
他方、macOSに標準導入されているCCIDインターフェースは、認証器[注1]をサポートしておりません。

したがって、macOS環境でOATHカードエミュレーション機能を利用するためには、[専用CCIDドライバー](../../CCID/INSTALLPRG.md)[注2]がインストールされている必要があります。

[注1] 本プロジェクトで製作された認証器は、正式にUSB I/FからベンダーIDを取得していないため、ダミーのベンダーIDを使用しています。このため、専用CCIDドライバーが無いと、認証器はmacOSから、CCIDデバイスとして認識されません。<br>
[注2] macOS環境上で、認証器をCCIDデバイスとして認識できるよう、カスタマイズされています。詳細につきましては[別ドキュメント](../../CCID/ccid_lib/README.md)をご参照願います。

#### サポート要件
最終更新日現在、[nRF52840アプリケーション](../../nRF52840_app)、[nRF5340アプリケーション](../../nRF5340_app)の両者に対応しております。

ただし、OATH-TOTP（現在時刻に基づくワンタイムパスワード）機能は、RTCC（リアルタイムクロック・カレンダー）モジュールを搭載した[MDBT50Q Dongle（rev2.2）](../../FIDO2Device/MDBT50Q_Dongle/pcb_rev2_2)のみのサポートとなります。

## 構成

#### 業務モジュール一覧

OATH機能のモジュールは、[`CCID/oath_lib`](../../CCID/oath_lib)配下に格納されています。<br>
すべて、プラットフォーム非依存となっております。

|#|モジュール名|説明|
|:---:|:---|:---|
|1|`ccid_oath_account.c/.h`|アカウント管理機能|
|2|`ccid_oath_calculate.c/.h`|ワンタイムパスワード計算機能|
|3|`ccid_oath_define.h`|OATHに関する定義体|
|4|`ccid_oath_list.c/.h`|アカウント一覧生成機能|
|5|`ccid_oath_object.c/.h`|データ永続化機能|
|6|`ccid_oath_totp.c/.h`|OATH-TOTP機能|
|7|`ccid_oath.c/.h`|エントリーモジュール|

#### 関連モジュール一覧

|#|モジュール格納パス|説明|
|:---:|:---|:---|
|1|`CCID/ccid_lib`|CCIDインターフェース共通モジュール<br>（プラットフォーム非依存）|
|2|`FIDO2Device/wrapper_header`|ラッパーモジュールのヘッダーファイル群[注1]|
|3|`nRF52840_app/examples/diverta/wrapper_lib`|ラッパーモジュール（nRF5 SDK依存）[注1]|
|4|`nRF52840_app/examples/diverta/plat_lib`|共通モジュール（nRF5 SDK依存）[注2]|
|5|`nRF5340_app/secure_device_app/wrapper`|ラッパーモジュール（Zephyrプラットフォーム依存）[注1]|
|6|`nRF5340_app/secure_device_app/src`|共通モジュール（Zephyrプラットフォーム依存）[注2]|

[注1]ラッパーモジュール＝nRF5 SDK／Zephyrプラットフォーム依存のC関数を、業務モジュールから呼び出すための中間関数群。このモジュールにより、業務モジュールを、nRF52840アプリケーション、nRF5340アプリケーションの両方で動作させることが可能になっています。<br>
[注2]共通モジュール＝業務間で共通利用する機能（永続化／暗号化／タイマー操作／RTCC操作など）を実行する関数。ラッパーモジュール内で呼び出されます。

## 仕様
OATH機能に関する仕様は以下になります。

### 論理仕様

#### コマンド
本プロジェクトで実行できるOATH機能のコマンドは、下記一覧の通りとなっております。<br>
（最終更新日現在、業務モジュールに実装されているもの）

リクエスト／レスポンスの詳細仕様については、別ドキュメント<b>「[詳細仕様](../../CCID/oath_lib/SPEC_DETAIL.md)」</b>をご参照願います。

|#|INS|名称|説明|
|:---:|:---|:---|:---|
|1|`0x01`|`OATH_INS_PUT`|認証器にクレデンシャルを個別登録[注1][注2][注3]|
|2|`0x02`|`OATH_INS_DELETE`|認証器に登録されているクレデンシャルを個別削除|
|3|`0x03`|`OATH_INS_LIST`|認証器に登録されているアカウント名の一覧を抽出|
|4|`0x04`|`OATH_INS_CALCULATE`|ワンタイムパスワードを計算|
|5|`0xA4`|`OATH_INS_SELECT`|Appletを実行可能化|
|6|`0xAF`|`OATH_INS_RESET`|OATH機能を無効化[注4]|

[注1]クレデンシャル＝アカウント名、Secret（暗号）等の項目を持つ機密データのセットです。<br>
[注2]クレデンシャルは平文転送されます。<br>
[注3]転送されたデータは、認証器内のFlash ROMに格納されます。上書きが可能です。<br>
[注4]一般的なOATH機能ではなく、[管理ツール](../../MaintenanceTool/README.md)から実行される想定の専用機能です。

#### 管理対象データオブジェクト
本プロジェクトで管理対象とするデータオブジェクト（OATH機能で使用する各種機密データ）は、下記一覧の通りとなっております。[注1]

|#|TAG|名称|説明|
|:---:|:---|:---|:---|
|1|`0x71`|`OATH_TAG_NAME`|アカウントデータ[注2]|

[注1]内部生成／インストールされたオブジェクトは、認証器内のFlash ROMに格納されます。<br>
[注2]クレデンシャルに連番を付与し、ユニーク管理します。

#### AID（Application Identifier）
本プロジェクトでAIDとして設定する値になります。

|#|名称|内容|意味|
|:---:|:---|:---|:---|
|1|AID|`a0 00 00 05 27 21 01`|OATHアプリケーションの固有ID|

#### ワンタイムパスワード

OATH-TOTP（ワンタイムパスワード）の計算仕様は以下になります。

|#|項目|内容|
|:---:|:---|:---|
|1|リクエスト受領|OATH-TOTPクライアント[注1]から、ワンタイムパスワード計算リクエストを<br>受領|
|2|Secret読出し|ワンタイムパスワード計算に必要なHMAC暗号を、Flash ROMから読出し|
|3|Challenge抽出|ワンタイムパスワード計算に必要な任意値（チャレンジ）を、リクエスト<br>パラメーターから抽出|
|4|HMACハッシュ計算|前述、Secret／Challengeを使用し、HMACハッシュを計算|
|5|オフセット計算|ハッシュ計算結果（バイト配列）の末尾バイトから、４ビット分の数値を抽出<br>（0 - 15までの数値）し、これをオフセット（次項、ハッシュ部分抽出を行う<br>バイトの位置）として設定|
|6|ハッシュ部分抽出|ハッシュ計算結果のオフセット位置のバイトから、後方31ビット分を抽出[注2]|
|7|レスポンス送信|前項の31ビットデータを、OATH-TOTP桁数と共に、ワンタイムパスワード<br>計算リクエストのレスポンスとして送信<br>（バイトオーダー＝ビッグエンディアン）[注3]|

[注1][管理ツール](../../MaintenanceTool/README.md)の「OATH設定」画面内（最終更新日現在、開発中）に実装予定です。<br>
[注2]`m_digest[offset]`からは７ビット、それ以外の`m_digest[offset+1]`〜`m_digest[offset+3]`からは８ビットずつ取得し、合計31ビットを取得します。<br>
[注3]このレスポンスを受け取ったOATH-TOTPクライアントは、レスポンスのビッグエンディアン形式バイト配列を数値変換（`totp_src_int`）したのち、下６桁の数値を抽出（`totp_src_int % 1000000`）し、６桁の「ワンタイムパスワード」として文字列表示することになります。

### 物理仕様

#### 永続化構造

Flash ROMにデータオブジェクトを登録する時のデータ構造は以下になります。

|#|Offset|Bytes|名称|説明|
|:---:|:---:|:---:|:---|:---|
|1|`0`|`2`|データオブジェクト長|データオブジェクトの長さを`uint16_t`形式で保持<br>（単位＝`bytes`）|
|2|`2`|`2`|データオブジェクト連番|データオブジェクトの連番を`uint16_t`形式で保持<br>（最小連番＝`1`）|
|3|`4`|`NN`|データオブジェクト本体|個別データオブジェクトを保持<br>`NN`＝最大`1,024`バイト（`256`ワード分の領域）|

個別データオブジェクトの仕様は以下になります。

##### （１）アカウントデータ

|#|Offset|Bytes|名称|説明|
|:---:|:---:|:---:|:---|:---|
|1|`0`|`64`|アカウント|OATHユーザーを識別する名称。<br>例：`Example:alice@google.com`|
|2|`64`|`1`|アカウント長|アカウントの長さを`uint8_t`形式で保持<br>（右側のスペース文字は含まれません）|
|3|`65`|`1`|アルゴリズム|OATH機能のアルゴリズムを`uint8_t`形式で保持[注1]|
|4|`66`|`1`|OTP桁数|ワンタイムパスワードの桁数|
|5|`67`|`64`|Secret|ワンタイムパスワードを計算するためのHMAC暗号を保持[注2]|
|6|`131`|`1`|Secret長|Secretの長さを`uint8_t`形式で保持|
|7|`132`|`1`|オプション属性|OATH機能のオプション指定を`uint8_t`形式で保持|
|8|`133`|`8`|Challenge|ワンタイムパスワードを計算するための任意値（チャレンジ）<br>を保持[注2]|

[注1]上４ビット＝機能種別（`1`:HOTP、`2`:TOTP）、下４ビット＝ハッシュアルゴリズム（`1`:SHA-1、`2`:SHA-256）<br>
[注2]バイトエンコードされたデータを保持。HMAC-SHA256ハッシュ計算時に使用します。
